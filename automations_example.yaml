# Exemples d'automatisations pour Inventory Manager
# √Ä ajouter dans automations.yaml

# ===== NOTIFICATION DE P√âREMPTION =====
- id: inventory_expiry_notification
  alias: "Notification produit p√©rimant"
  description: "Envoie une notification quand un produit approche de la p√©remption"
  trigger:
    - platform: event
      event_type: inventory_manager_product_expiring
  action:
    - service: notify.mobile_app_votre_telephone  # Remplacez par votre service de notification
      data:
        title: >
          {% if trigger.event.data.notification_type == 'expired' %}
            üö® Produit p√©rim√© !
          {% elif trigger.event.data.notification_type == 'use_today' %}
            ‚ö° √Ä consommer rapidement !
          {% else %}
            ‚è∞ P√©remption proche
          {% endif %}
        message: >
          {% set name = trigger.event.data.name %}
          {% set days = trigger.event.data.days_until_expiry %}
          {% set location = trigger.event.data.location %}
          {% if trigger.event.data.notification_type == 'expired' %}
            {{ name }} est P√âRIM√â depuis {{ days | abs }} jour(s) !
          {% elif days == 0 %}
            {{ name }} expire AUJOURD'HUI - √Ä utiliser imm√©diatement !
          {% elif days == 1 %}
            {{ name }} expire DEMAIN
          {% else %}
            {{ name }} expire dans {{ days }} jours
          {% endif %}
        data:
          tag: "inventory_expiry_{{ trigger.event.data.product_id }}"
          group: "inventory_expiry"
          # Actions pour l'app mobile
          actions:
            - action: "REMOVE_PRODUCT"
              title: "Supprimer"
              uri: "/api/services/inventory_manager/remove_product"
            - action: "DISMISS"
              title: "OK"

# ===== R√âPONSE √Ä L'ACTION DE NOTIFICATION =====
- id: inventory_notification_action
  alias: "Action notification inventaire"
  description: "G√®re les actions des notifications d'inventaire"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "REMOVE_PRODUCT"
  action:
    - service: inventory_manager.remove_product
      data:
        product_id: "{{ trigger.event.data.tag | replace('inventory_expiry_', '') }}"
    - service: notify.mobile_app_votre_telephone
      data:
        message: "Produit supprim√© de l'inventaire"

# ===== NOTIFICATION PRODUIT AJOUT√â =====
- id: inventory_product_added
  alias: "Notification produit ajout√©"
  description: "Confirme l'ajout d'un produit"
  trigger:
    - platform: event
      event_type: inventory_manager_product_added
  action:
    - service: notify.mobile_app_votre_telephone
      data:
        title: "‚úÖ Produit ajout√©"
        message: "{{ trigger.event.data.name }} ajout√© au {{ trigger.event.data.location }}"
        data:
          tag: "inventory_added"
          timeout: 5

# ===== R√âSUM√â QUOTIDIEN =====
- id: inventory_daily_summary
  alias: "R√©sum√© inventaire quotidien"
  description: "Envoie un r√©sum√© quotidien des produits √† surveiller"
  trigger:
    - platform: time
      at: "08:00:00"
  condition:
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: sensor.gestionnaire_d_inventaire_produits_perimant_bientot
          above: 0
        - condition: numeric_state
          entity_id: sensor.gestionnaire_d_inventaire_produits_perimes
          above: 0
  action:
    - service: notify.mobile_app_votre_telephone
      data:
        title: "üìã R√©sum√© inventaire"
        message: >
          {% set expiring = states('sensor.gestionnaire_d_inventaire_produits_perimant_bientot') | int %}
          {% set expired = states('sensor.gestionnaire_d_inventaire_produits_perimes') | int %}
          {% if expired > 0 %}üö® {{ expired }} produit(s) p√©rim√©(s){% endif %}
          {% if expiring > 0 %}‚ö†Ô∏è {{ expiring }} produit(s) √† consommer bient√¥t{% endif %}

# ===== SCAN CODE-BARRES DEPUIS COMPANION APP =====
- id: inventory_barcode_scan
  alias: "Scan code-barres inventaire"
  description: "G√®re le scan de code-barres depuis l'app companion"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "BARCODE_SCANNED"
  action:
    - service: inventory_manager.scan_product
      data:
        barcode: "{{ trigger.event.data.barcode }}"
        expiry_date: "{{ (now() + timedelta(days=30)).strftime('%Y-%m-%d') }}"
        location: "freezer"
      response_variable: result
    - service: notify.mobile_app_votre_telephone
      data:
        title: "üì¶ Produit scann√©"
        message: >
          {% if result.success %}
            {{ result.name }} ajout√© !
            {% if result.warning %}({{ result.warning }}){% endif %}
          {% else %}
            Erreur: {{ result.error }}
          {% endif %}
